<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Warden Dashboard</title>

<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<script>
tailwind.config = {
  theme:{
    extend:{
      colors:{
        aqua:'#64FFDA',
        navy:'#0A192F',
        light:'#F0F2F5'
      }
    }
  }
}
</script>
</head>

<body class="bg-light font-['Inter']">

<div class="flex min-h-screen">

<!-- SIDEBAR -->
<aside class="hidden md:flex w-64 bg-navy text-white flex-col p-4">
  <h1 class="text-xl font-bold mb-6">ðŸ›¡ Warden OS</h1>

  <a class="px-3 py-2 rounded-lg bg-aqua/10 text-aqua mb-2 flex gap-2 items-center">
    <span class="material-symbols-outlined">dashboard</span> Dashboard
  </a>

  <div class="mt-auto border-t border-white/10 pt-4">
    <button id="logoutBtn" class="text-red-400 flex gap-2 items-center">
      <span class="material-symbols-outlined">logout</span> Logout
    </button>
  </div>
</aside>

<!-- MAIN -->
<main class="flex-1 flex flex-col">

<header class="bg-white border-b px-6 py-4">
  <h2 class="text-2xl font-bold">Admin Dashboard</h2>
</header>

<!-- CARDS -->
<section class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
  <div id="totalCard" class="bg-white p-6 rounded-xl shadow">
    <p>Total</p><h3 id="totalCount" class="text-3xl font-bold">0</h3>
  </div>
  <div id="pendingCard" class="bg-red-100 p-6 rounded-xl shadow">
    <p>Pending</p><h3 id="pendingCount" class="text-3xl font-bold">0</h3>
  </div>
  <div id="progressCard" class="bg-yellow-100 p-6 rounded-xl shadow">
    <p>In Progress</p><h3 id="progressCount" class="text-3xl font-bold">0</h3>
  </div>
  <div id="resolvedCard" class="bg-green-100 p-6 rounded-xl shadow">
    <p>Resolved</p><h3 id="resolvedCount" class="text-3xl font-bold">0</h3>
  </div>
</section>

<!-- TABLE -->
<section class="p-6">
<div class="bg-white rounded-xl shadow overflow-hidden">
<table class="w-full text-sm">
<thead class="bg-light">
<tr>
  <th class="px-6 py-3">Student</th>
  <th class="px-6 py-3">Title</th>
  <th class="px-6 py-3">Description</th>
  <th class="px-6 py-3">Date</th>
  <th class="px-6 py-3">Status</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>
</div>
</section>

</main>
</div>

<script>
const token = localStorage.getItem("token");
if (!token) location.href = "login.html";

const API = "http://localhost:5000/api/complaints";

// ðŸ”µ load all complaints (WARDEN)
async function loadComplaints() {
  const res = await fetch(`${API}/all`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const complaints = await res.json();

  document.getElementById("totalCount").innerText = complaints.length;
  document.getElementById("pendingCount").innerText =
    complaints.filter(c => c.status === "Pending").length;
  document.getElementById("progressCount").innerText =
    complaints.filter(c => c.status === "In Progress").length;
  document.getElementById("resolvedCount").innerText =
    complaints.filter(c => c.status === "Resolved").length;

  const table = document.getElementById("table");
  table.innerHTML = "";

  complaints.forEach(c => {
    table.innerHTML += `
      <tr class="border-t">
        <td class="px-6 py-3">${c.user?.name || "Student"}</td>
        <td class="px-6 py-3">${c.title}</td>
        <td class="px-6 py-3">${c.description}</td>
        <td class="px-6 py-3">${new Date(c.createdAt).toLocaleDateString()}</td>
        <td class="px-6 py-3">
          <select class="rounded-full px-3 py-1 font-semibold
            ${c.status==="Pending"?"bg-red-100 text-red-700":
              c.status==="In Progress"?"bg-yellow-100 text-yellow-700":
              "bg-green-100 text-green-700"}"
            onchange="updateStatus('${c._id}', this.value)">
            <option ${c.status==="Pending"?"selected":""}>Pending</option>
            <option ${c.status==="In Progress"?"selected":""}>In Progress</option>
            <option ${c.status==="Resolved"?"selected":""}>Resolved</option>
          </select>
        </td>
      </tr>`;
  });
}

// ðŸ”„ UPDATE STATUS (CORRECT ROUTE)
async function updateStatus(id, status) {
  await fetch(`${API}/status/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ status })
  });

  loadComplaints();
}

// ðŸšª LOGOUT
document.getElementById("logoutBtn").onclick = () => {
  localStorage.clear();
  location.href = "login.html";
};

loadComplaints();
</script>

</body>
</html>
